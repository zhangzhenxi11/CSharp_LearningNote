# WpfDiagram 系统架构图

## 🏗️ 整体架构图

```mermaid
graph TB
    subgraph "应用层 (TestApp)"
        APP[App.xaml]
        MAIN[MainWindow]
        FLOW[FlowchartEditor]
        SHAPE[ShapesEditor]
        PROP[PropertiesView]
    end
    
    subgraph "控制器层 (Controllers)"
        CTRL[Controller]
        SCTRL[ShapesController]
        ICTRL[IDiagramController]
    end
    
    subgraph "视图层 (Views)"
        DV[DiagramView]
        DSV[DiagramScrollView]
        SEL[Selection]
    end
    
    subgraph "工具层 (Tools)"
        IT[InputTool]
        MRT[MoveResizeTool]
        LT[LinkTool]
        DDT[DragDropTool]
    end
    
    subgraph "装饰器层 (Adorners)"
        DA[DragAdorner]
        LA[LinkAdorner]
        MRA[MoveResizeAdorner]
        RA[RubberbandAdorner]
        SA[SelectionAdorner]
    end
    
    subgraph "控件层 (Controls)"
        DI[DiagramItem]
        NODE[Node]
        LINK[LinkBase]
        PORT[PortBase]
    end
    
    subgraph "基础设施层 (Infrastructure)"
        GH[GeometryHelper]
        VH[VisualHelper]
        DC[DebuggingConverter]
    end
    
    APP --> MAIN
    MAIN --> FLOW
    MAIN --> SHAPE
    MAIN --> PROP
    
    FLOW --> CTRL
    SHAPE --> SCTRL
    CTRL --> ICTRL
    SCTRL --> ICTRL
    
    CTRL --> DV
    DV --> DSV
    DV --> SEL
    
    DV --> IT
    IT --> MRT
    IT --> LT
    IT --> DDT
    
    MRT --> MRA
    LT --> LA
    IT --> RA
    DI --> SA
    DV --> DA
    
    DV --> DI
    DI --> NODE
    DI --> LINK
    NODE --> PORT
    
    NODE --> GH
    LINK --> VH
    DV --> DC
```

## 🔄 交互流程图

```mermaid
sequenceDiagram
    participant U as User
    participant DV as DiagramView
    participant IT as InputTool
    participant MT as MoveResizeTool
    participant A as Adorner
    participant C as Controller
    participant M as Model
    
    U->>DV: 鼠标点击
    DV->>IT: OnMouseDown
    IT->>IT: 检测命中元素
    IT->>DV: 更新Selection
    
    U->>DV: 鼠标拖拽
    DV->>IT: OnMouseMove
    IT->>MT: BeginDrag
    MT->>A: 创建DragAdorner
    A->>DV: 显示拖拽反馈
    
    U->>DV: 鼠标释放
    DV->>IT: OnMouseUp
    IT->>MT: EndDrag
    MT->>C: UpdateItemsBounds
    C->>M: 更新数据模型
    M->>DV: 触发视图更新
```

## 🧩 组件依赖图

```mermaid
graph LR
    subgraph "核心接口"
        IN[INode]
        IP[IPort]
        IL[ILink]
        IDC[IDiagramController]
        IIT[IInputTool]
    end
    
    subgraph "具体实现"
        N[Node]
        EP[EllipsePort]
        RP[RectPort]
        SL[SegmentLink]
        OL[OrthogonalLink]
    end
    
    subgraph "工具实现"
        IT[InputTool]
        MRT[MoveResizeTool]
        LT[LinkTool]
    end
    
    N -.implements.-> IN
    EP -.implements.-> IP
    RP -.implements.-> IP
    SL -.implements.-> IL
    OL -.implements.-> IL
    
    IT -.implements.-> IIT
    
    N --> IP
    IL --> IP
    
    IT --> MRT
    IT --> LT
```

## 📦 模块组织图

```mermaid
graph TB
    subgraph "Aga.Diagrams.dll"
        subgraph "Controls"
            NC["Node Controls"]
            PC["Port Controls"]
            LC["Link Controls"]
            BC["Base Controls"]
        end
        
        subgraph "Adorners"
            DA["Drag Adorners"]
            SA["Selection Adorners"]
            LA["Link Adorners"]
        end
        
        subgraph "Tools"
            BT["Basic Tools"]
            AT["Advanced Tools"]
        end
        
        subgraph "Core"
            DV["DiagramView"]
            SEL["Selection"]
            CTRL["Controller Interface"]
        end
        
        subgraph "Utils"
            GEO["Geometry Utils"]
            VIS["Visual Utils"]
        end
    end
    
    subgraph "TestApp.exe"
        subgraph "Examples"
            FC["Flowchart"]
            SH["Shapes"]
        end
        
        subgraph "Infrastructure"
            HELP["Helpers"]
            CONV["Converters"]
        end
    end
    
    FC --> DV
    SH --> DV
    HELP --> GEO
    CONV --> VIS
```

## 🎯 功能模块图

```mermaid
graph TB
    subgraph "🔧 图形编辑"
        A1["节点管理"]
        A2["连接管理"]
        A3["选择操作"]
        
        A1 --> A11["节点创建"]
        A1 --> A12["节点删除"]
        A1 --> A13["节点选择"]
        A1 --> A14["节点移动"]
        A1 --> A15["节点调整大小"]
        
        A2 --> A21["连接创建"]
        A2 --> A22["连接删除"]
        A2 --> A23["连接重路由"]
        A2 --> A24["连接样式"]
        
        A3 --> A31["单选"]
        A3 --> A32["多选"]
        A3 --> A33["框选"]
        A3 --> A34["反选"]
    end
    
    subgraph "🎨 视觉反馈"
        B1["装饰器"]
        B2["动画效果"]
        B3["网格显示"]
        
        B1 --> B11["选择框"]
        B1 --> B12["拖拽预览"]
        B1 --> B13["连接预览"]
        B1 --> B14["调整手柄"]
        
        B2 --> B21["拖拽动画"]
        B2 --> B22["连接动画"]
        
        B3 --> B31["网格绘制"]
        B3 --> B32["对齐辅助"]
    end
    
    subgraph "🕹️ 交互控制"
        C1["鼠标操作"]
        C2["键盘操作"]
        C3["命令系统"]
        
        C1 --> C11["点击选择"]
        C1 --> C12["拖拽移动"]
        C1 --> C13["右键菜单"]
        
        C2 --> C21["快捷键"]
        C2 --> C22["复制粘贴"]
        C2 --> C23["删除"]
        
        C3 --> C31["撤销重做"]
        C3 --> C32["批量操作"]
    end
    
    subgraph "🔗 数据绑定"
        D1["MVVM支持"]
        D2["属性绑定"]
        
        D1 --> D11["数据模型"]
        D1 --> D12["视图更新"]
        D1 --> D13["命令绑定"]
        
        D2 --> D21["双向绑定"]
        D2 --> D22["转换器"]
    end
```

## 🗺️ 功能概览图

```mermaid
flowchart LR
    subgraph "📝 基础功能"
        CREATE["创建节点"]
        SELECT["选择元素"]
        MOVE["移动元素"]
        RESIZE["调整大小"]
        DELETE["删除元素"]
    end
    
    subgraph "🔗 连接功能"
        LINK_CREATE["创建连接"]
        LINK_EDIT["编辑连接"]
        LINK_DELETE["删除连接"]
        PORT_MANAGE["端口管理"]
    end
    
    subgraph "🎨 视觉效果"
        SELECTION_BOX["选择框"]
        DRAG_PREVIEW["拖拽预览"]
        GRID_DISPLAY["网格显示"]
        ADORNERS["装饰器"]
    end
    
    subgraph "⚙️ 高级功能"
        UNDO_REDO["撤销重做"]
        COPY_PASTE["复制粘贴"]
        KEYBOARD["快捷键"]
        DATA_BINDING["数据绑定"]
    end
    
    CREATE --> ADORNERS
    SELECT --> SELECTION_BOX
    MOVE --> DRAG_PREVIEW
    LINK_CREATE --> PORT_MANAGE
    DELETE --> UNDO_REDO
```

## 🔧 工具链架构图

```mermaid
graph LR
    subgraph "事件源"
        MOUSE[鼠标事件]
        KEY[键盘事件]
        DRAG[拖放事件]
    end
    
    subgraph "事件分发"
        DV[DiagramView]
        IT[InputTool]
    end
    
    subgraph "具体工具"
        MT[MoveResizeTool]
        LT[LinkTool]
        DT[DragDropTool]
        ST[SelectionTool]
    end
    
    subgraph "视觉反馈"
        MA[MoveAdorner]
        LA[LinkAdorner]
        RA[RubberBandAdorner]
        SA[SelectionAdorner]
    end
    
    subgraph "数据更新"
        CTRL[Controller]
        MODEL[DataModel]
    end
    
    MOUSE --> DV
    KEY --> DV
    DRAG --> DV
    
    DV --> IT
    
    IT --> MT
    IT --> LT
    IT --> DT
    IT --> ST
    
    MT --> MA
    LT --> LA
    ST --> RA
    ST --> SA
    
    MT --> CTRL
    LT --> CTRL
    DT --> CTRL
    
    CTRL --> MODEL
```

## 🎨 样式和模板架构

```mermaid
graph TB
    subgraph "样式资源 (themes)"
        GENERIC["generic.xaml"]
        SHARED["Shared.xaml"]
    end
    
    subgraph "控件模板"
        DT["DiagramView.xaml"]
        NT["Node.xaml"]
        LT["LinkBase.xaml"]
        PT["Port Templates"]
    end
    
    subgraph "装饰器模板"
        SF["SelectionFrame.xaml"]
        RC["RelinkControl.xaml"]
    end
    
    subgraph "应用样式"
        APP["App.xaml"]
        MAIN["MainWindow.xaml"]
        FLOW["FlowchartEditor.xaml"]
    end
    
    GENERIC --> DT
    GENERIC --> NT
    GENERIC --> LT
    GENERIC --> PT
    
    SHARED --> SF
    SHARED --> RC
    
    APP --> MAIN
    APP --> FLOW
    
    MAIN --> GENERIC
    FLOW --> GENERIC
```

## 🔍 数据流图

```mermaid
graph LR
    subgraph "用户输入"
        UI[User Input]
    end
    
    subgraph "事件处理"
        EH[Event Handler]
        IT[Input Tool]
    end
    
    subgraph "业务逻辑"
        CTRL[Controller]
        VAL[Validation]
    end
    
    subgraph "数据层"
        MODEL[Data Model]
        COLL[Collections]
    end
    
    subgraph "视图更新"
        BIND[Data Binding]
        UI_UPDATE[UI Update]
    end
    
    UI --> EH
    EH --> IT
    IT --> CTRL
    CTRL --> VAL
    VAL --> MODEL
    MODEL --> COLL
    COLL --> BIND
    BIND --> UI_UPDATE
    UI_UPDATE --> UI
```

这些架构图从不同角度展示了WpfDiagram项目的设计结构，帮助你更好地理解整个系统的组织方式和工作原理。

---

## 📝 图表说明

### Mermaid 语法要点
- 所有节点文本都用双引号包裹，避免特殊字符问题
- 子图（subgraph）名称用双引号包裹，支持中文显示
- 使用合适的图表类型：
  - `graph TB/LR`: 基础流程图
  - `flowchart LR`: 现代流程图
  - `sequenceDiagram`: 时序图

### 查看建议
- 建议使用支持 Mermaid 的 Markdown 编辑器查看（如 Typora、VS Code）
- 在线查看：[Mermaid Live Editor](https://mermaid.live/)
- 如果图表不显示，请检查 Markdown 预览器是否支持 Mermaid 语法

### 学习价值
这些架构图特别适合学习 C# 和 WPF 开发，展示了：
- **设计模式的实际应用**：策略模式、装饰器模式、观察者模式等
- **WPF 架构最佳实践**：MVVM、数据绑定、控件开发
- **大型项目的组织结构**：分层架构、模块化设计
- **交互系统的设计思路**：事件处理、工具链、视觉反馈