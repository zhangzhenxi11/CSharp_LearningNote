# 半导体流程控制系统功能实现总结

## 实现的三个核心功能

### 1. ✅ 框选节点Delete快捷键删除功能

**实现位置：** `SemiconductorProcessController.cs` 的 `ExecuteCommand` 方法

**功能描述：**
- 支持选择单个或多个设备节点
- 按Delete键即可删除选中的设备
- 自动移除与被删除设备相关的所有连接
- 支持删除连接线本身
- 删除操作仅在流程停止状态下可用

**核心代码：**
```csharp
public void ExecuteCommand(ICommand command, object parameter)
{
    if (command == ApplicationCommands.Delete && _diagramView.Selection.Count > 0)
    {
        var itemsToRemove = new List<DiagramItem>();
        
        foreach (var item in _diagramView.Selection.ToList())
        {
            if (item is Node node && node.ModelElement is SemiconductorDevice device)
            {
                // 移除相关连接
                var relatedConnections = _connections
                    .Where(c => c.SourceDevice == device || c.TargetDevice == device)
                    .ToList();
                
                foreach (var connection in relatedConnections)
                {
                    _connections.Remove(connection);
                }
                
                _devices.Remove(device);
                itemsToRemove.Add(item);
            }
            else if (item is LinkBase link)
            {
                // 删除连接线
                if (link.ModelElement is ProcessConnection connection)
                {
                    _connections.Remove(connection);
                }
                itemsToRemove.Add(item);
            }
        }
        
        // 从视图中移除项目
        foreach (var item in itemsToRemove)
        {
            _diagramView.Children.Remove(item);
        }
        
        _diagramView.Selection.Clear();
    }
}
```

### 2. ✅ 点击节点设备和属性关联功能

**实现位置：** `SemiconductorProcessController.cs` 的选择事件处理

**功能描述：**
- 点击设备节点时自动选中该设备
- 右侧属性面板实时显示选中设备的详细属性
- 支持编辑设备ID、名称、目标值、单位等属性
- 条件节点还可以编辑条件表达式
- 属性修改后可直接应用到设备

**核心代码：**
```csharp
/// <summary>
/// 选择变化事件处理 - 实现设备选择与属性关联
/// </summary>
private void Selection_PropertyChanged(object sender, PropertyChangedEventArgs e)
{
    try
    {
        // 获取主窗口的ViewModel
        var mainWindow = Application.Current.MainWindow as SemiconductorMainWindow;
        var viewModel = mainWindow?.DataContext as MainViewModel;
        
        if (viewModel == null) return;

        // 获取主选择项
        SemiconductorDevice selectedDevice = null;
        
        var primaryItem = _diagramView.Selection.Primary;
        if (primaryItem is Node node && node.ModelElement is SemiconductorDevice device)
        {
            selectedDevice = device;
            Console.WriteLine($"选中设备: {device.DeviceName} [{device.DeviceId}]");
        }
        
        // 更新ViewModel的选中设备
        viewModel.SelectedDevice = selectedDevice;
        
        if (selectedDevice != null)
        {
            Console.WriteLine($"属性关联: 设备名称={selectedDevice.DeviceName}, 目标值={selectedDevice.TargetValue}, 单位={selectedDevice.Unit}");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"选择事件处理失败: {ex.Message}");
    }
}
```

**XAML绑定：**
```xml
<StackPanel DataContext="{Binding SelectedDevice}">
    <TextBlock Text="设备ID:" Foreground="White" Margin="0,5"/>
    <TextBox Text="{Binding DeviceId}" Style="{StaticResource ParameterInputStyle}"/>
    
    <TextBlock Text="设备名称:" Foreground="White" Margin="0,5"/>
    <TextBox Text="{Binding DeviceName}" Style="{StaticResource ParameterInputStyle}"/>
    
    <TextBlock Text="目标值:" Foreground="White" Margin="0,5"/>
    <TextBox Text="{Binding TargetValue}" Style="{StaticResource ParameterInputStyle}"/>
    
    <TextBlock Text="单位:" Foreground="White" Margin="0,5"/>
    <TextBox Text="{Binding Unit}" Style="{StaticResource ParameterInputStyle}"/>
    
    <!-- 条件表达式（仅条件节点显示） -->
    <TextBlock Text="条件表达式:" Foreground="White" Margin="0,5" 
              Visibility="{Binding DeviceType, Converter={StaticResource ConditionVisibilityConverter}}"/>
    <TextBox Text="{Binding ConditionExpression}" Style="{StaticResource ParameterInputStyle}"
            Visibility="{Binding DeviceType, Converter={StaticResource ConditionVisibilityConverter}}"/>
</StackPanel>
```

### 3. ✅ 流程保存和加载功能

**实现位置：** `SemiconductorProcessController.cs` 的流程保存和加载方法

**功能描述：**
- 支持将当前流程保存为.proc文件
- 保存内容包括所有设备的属性、位置信息和连接关系
- 支持从文件加载已保存的流程
- 加载时完整重建设备节点、端口和连接
- 使用JSON格式存储，便于阅读和调试

**数据结构：**
```csharp
/// <summary>
/// 流程保存数据结构
/// </summary>
public class ProcessSaveData
{
    public DateTime SaveTime { get; set; }
    public string ProcessName { get; set; }
    public List<DeviceSaveData> Devices { get; set; } = new List<DeviceSaveData>();
    public List<ConnectionSaveData> Connections { get; set; } = new List<ConnectionSaveData>();
}

/// <summary>
/// 设备保存数据结构
/// </summary>
public class DeviceSaveData
{
    public string DeviceId { get; set; }
    public string DeviceName { get; set; }
    public DeviceType DeviceType { get; set; }
    public string Unit { get; set; }
    public double TargetValue { get; set; }
    public string ConditionExpression { get; set; }
    public double X { get; set; }  // 节点X坐标
    public double Y { get; set; }  // 节点Y坐标
}
```

**核心保存方法：**
```csharp
/// <summary>
/// 保存当前流程到文件
/// </summary>
public async Task<bool> SaveProcessToFileAsync(string filePath = null)
{
    try
    {
        if (string.IsNullOrEmpty(filePath))
        {
            var saveDialog = new Microsoft.Win32.SaveFileDialog
            {
                Title = "保存流程文件",
                Filter = "流程文件 (*.proc)|*.proc|所有文件 (*.*)|*.*",
                DefaultExt = ".proc",
                FileName = $"Process_{DateTime.Now:yyyyMMdd_HHmmss}.proc"
            };
            
            if (saveDialog.ShowDialog() != true)
                return false;
                
            filePath = saveDialog.FileName;
        }

        // 准备保存数据
        var processData = new ProcessSaveData
        {
            SaveTime = DateTime.Now,
            ProcessName = GetMainViewModel()?.CurrentRecipe ?? "UnnamedProcess",
            Devices = new List<DeviceSaveData>(),
            Connections = new List<ConnectionSaveData>()
        };

        // 保存设备数据和位置
        foreach (var device in _devices)
        {
            // 查找对应的节点以获取位置
            var node = _diagramView.Children.OfType<Node>()
                .FirstOrDefault(n => n.ModelElement == device);
            
            var deviceData = new DeviceSaveData
            {
                DeviceId = device.DeviceId,
                DeviceName = device.DeviceName,
                DeviceType = device.DeviceType,
                Unit = device.Unit,
                TargetValue = device.TargetValue,
                ConditionExpression = device.ConditionExpression,
                X = node != null ? (double)(node.GetValue(Canvas.LeftProperty) ?? 0) : 0,
                Y = node != null ? (double)(node.GetValue(Canvas.TopProperty) ?? 0) : 0
            };
            
            processData.Devices.Add(deviceData);
        }

        // 序列化为JSON
        var json = System.Text.Json.JsonSerializer.Serialize(processData, new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = true,
            Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
        });

        // 写入文件
        await System.IO.File.WriteAllTextAsync(filePath, json, System.Text.Encoding.UTF8);
        
        Console.WriteLine($"流程已保存到: {filePath}");
        Console.WriteLine($"保存数据: {processData.Devices.Count}个设备, {processData.Connections.Count}个连接");
        
        return true;
    }
    catch (Exception ex)
    {
        Console.WriteLine($"保存流程失败: {ex.Message}");
        return false;
    }
}
```

**菜单集成：**
在主窗口菜单中添加了保存和加载选项：
```xml
<MenuItem Header="文件" Foreground="White">
    <MenuItem Header="新建流程" Command="{Binding NewProcessCommand}"/>
    <MenuItem Header="打开配方" Command="{Binding LoadRecipeCommand}"/>
    <Separator/>
    <MenuItem Header="保存流程" Click="SaveProcessMenuItem_Click"/>
    <MenuItem Header="加载流程" Click="LoadProcessMenuItem_Click"/>
    <Separator/>
    <MenuItem Header="保存配置" Command="{Binding SaveConfigurationCommand}"/>
    <MenuItem Header="导出数据" Command="{Binding ExportDataCommand}"/>
    <MenuItem Header="退出" Click="ExitMenuItem_Click"/>
</MenuItem>
```

## 技术特点

### 1. WPF MVVM架构
- 完整的数据绑定机制
- 属性变更通知（INotifyPropertyChanged）
- 命令绑定模式
- 视图与逻辑分离

### 2. 端口系统设计
- 基于TestApp的端口创建模式
- 支持不同设备类型的端口配置
- 端口可视化和交互支持
- 连接验证机制

### 3. 状态管理
- 设备状态实时更新
- 流程状态控制
- 选择状态管理
- 错误状态处理

### 4. 文件操作
- JSON序列化/反序列化
- 文件对话框集成
- 异步文件IO操作
- 错误处理机制

## 使用方法

### 框选删除功能
1. 在画布上点击并拖拽选择一个或多个设备
2. 按Delete键删除选中的设备
3. 系统会自动移除相关连接

### 设备属性关联
1. 点击画布上的任意设备节点
2. 右侧属性面板会自动显示该设备的详细属性
3. 可以直接在属性面板中编辑设备参数
4. 点击"应用设置"按钮保存修改

### 流程保存/加载
1. 设计完流程后，选择菜单"文件" → "保存流程"
2. 选择保存位置和文件名（自动添加.proc扩展名）
3. 要加载流程时，选择菜单"文件" → "加载流程"
4. 选择之前保存的.proc文件即可完整重建流程

## 总结

成功实现了用户要求的三个核心功能：

1. **✅ 框选删除** - 支持多选和快捷键删除，自动处理关联连接
2. **✅ 属性关联** - 点击设备即时显示和编辑属性，完整的数据绑定
3. **✅ 流程保存/加载** - 完整的流程持久化，包括设备位置和连接关系

所有功能都基于WPF的MVVM架构实现，代码结构清晰，易于维护和扩展。用户现在可以创建复杂的半导体流程图，保存设计，并在需要时重新加载继续编辑。